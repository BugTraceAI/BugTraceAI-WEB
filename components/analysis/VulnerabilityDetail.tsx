// components/analysis/VulnerabilityDetail.tsx
import React, { useState } from 'react';
import { Vulnerability } from '../../types';
import { SEVERITY_STYLES } from '../../constants';
import { ChevronDownIcon, ChevronUpIcon } from '../Icons';
import { MarkdownRenderer } from '../MarkdownRenderer';

interface VulnerabilityDetailProps {
  vulnerability: Vulnerability;
  index: number;
  targetUrl?: string;
  onReAnalyze?: (vuln: Vulnerability) => void;
}

export const VulnerabilityDetail: React.FC<VulnerabilityDetailProps> = ({
  vulnerability,
  index,
  targetUrl,
  onReAnalyze,
}) => {
  const severityStyle = SEVERITY_STYLES[vulnerability.severity] || SEVERITY_STYLES['Unknown'];
  const [isCodeExpanded, setIsCodeExpanded] = useState(true);
  const [isRecommendationExpanded, setIsRecommendationExpanded] = useState(false);

  const vulnerableCode = typeof vulnerability.vulnerableCode === 'string' ? vulnerability.vulnerableCode : '';

  return (
    <div
      className={`bg-purple-medium/50 backdrop-blur-sm border ${severityStyle.border} rounded-xl overflow-hidden shadow-lg ${severityStyle.shadow} animate-fade-in`}
      data-testid={`vulnerability-detail-${index}`}
    >
      {/* Header */}
      <header className={`p-4 flex justify-between items-start gap-4 ${severityStyle.headerBg} border-b ${severityStyle.border}`}>
        <div className="flex-grow">
          <div className="flex items-center gap-2">
            <span className="text-sm font-mono text-muted">#{index + 1}</span>
            <h4 className={`text-lg font-bold ${severityStyle.text}`}>
              {vulnerability.vulnerability || 'Unnamed Finding'}
            </h4>
          </div>
          {targetUrl && (
            <p className={`text-xs ${severityStyle.text} opacity-80 font-mono break-all mt-1`}>
              {targetUrl}
            </p>
          )}
        </div>
        <div className={`flex-shrink-0 px-3 py-1 text-sm font-bold rounded-full border-2 ${severityStyle.border} ${severityStyle.text} bg-black/30`}>
          {vulnerability.severity}
        </div>
      </header>

      {/* Content */}
      <div className="p-5 space-y-5">
        {/* Description */}
        <div>
          <h5 className="font-semibold text-white mb-2 text-sm uppercase tracking-wide text-coral-hover">
            Description
          </h5>
          <div className="text-sm text-purple-gray">
            <MarkdownRenderer content={vulnerability.description} />
          </div>
        </div>

        {/* Impact */}
        <div>
          <h5 className="font-semibold text-white mb-2 text-sm uppercase tracking-wide text-orange-300">
            Impact
          </h5>
          <p className="text-sm text-purple-gray">{vulnerability.impact}</p>
        </div>

        {/* Vulnerable Code/Pattern */}
        {vulnerableCode && (
          <div>
            <button
              onClick={() => setIsCodeExpanded(!isCodeExpanded)}
              className="w-full flex justify-between items-center text-left font-semibold text-white py-2 text-sm uppercase tracking-wide text-purple-300 hover:text-purple-200 transition-colors"
            >
              Vulnerable Code / Pattern
              {isCodeExpanded ? <ChevronUpIcon className="h-5 w-5" /> : <ChevronDownIcon className="h-5 w-5" />}
            </button>
            {isCodeExpanded && (
              <pre className="w-full bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-0 rounded-lg p-4 text-purple-200 text-sm overflow-x-auto backdrop-blur-sm">
                <code>{vulnerableCode}</code>
              </pre>
            )}
          </div>
        )}

        {/* Injection Point */}
        {vulnerability.injectionPoint && (
          <div>
            <h5 className="font-semibold text-white mb-2 text-sm uppercase tracking-wide text-red-300">
              Injection Point
            </h5>
            <div className="bg-black/20 border border-red-500/30 rounded-lg p-3 space-y-1">
              <p className="text-sm text-purple-gray">
                <span className="font-semibold text-red-300">Type:</span>{' '}
                {vulnerability.injectionPoint.type}
              </p>
              <p className="text-sm text-purple-gray">
                <span className="font-semibold text-red-300">Parameter:</span>{' '}
                <code className="text-purple-200 bg-purple-900/30 px-2 py-0.5 rounded">
                  {vulnerability.injectionPoint.parameter}
                </code>
              </p>
              {vulnerability.injectionPoint.method && (
                <p className="text-sm text-purple-gray">
                  <span className="font-semibold text-red-300">Method:</span>{' '}
                  {vulnerability.injectionPoint.method}
                </p>
              )}
            </div>
          </div>
        )}

        {/* Recommendation */}
        <div>
          <button
            onClick={() => setIsRecommendationExpanded(!isRecommendationExpanded)}
            className="w-full flex justify-between items-center text-left font-semibold text-white py-2 text-sm uppercase tracking-wide text-green-300 hover:text-green-200 transition-colors"
          >
            Recommendation
            {isRecommendationExpanded ? <ChevronUpIcon className="h-5 w-5" /> : <ChevronDownIcon className="h-5 w-5" />}
          </button>
          {isRecommendationExpanded && (
            <div className="text-sm text-purple-gray border-t border-0 pt-3">
              <MarkdownRenderer content={vulnerability.recommendation} />
            </div>
          )}
        </div>

        {/* Re-analyze Button */}
        {onReAnalyze && (
          <div className="pt-3 border-t border-0">
            <button
              onClick={() => onReAnalyze(vulnerability)}
              className="w-full flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-semibold gradient-blue-indigo text-white rounded-lg hover:brightness-110 transition-all duration-300 shadow-md shadow-blue-500/20"
            >
              <svg
                className="h-5 w-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
              Re-analyze with Agent
            </button>
          </div>
        )}
      </div>
    </div>
  );
};
