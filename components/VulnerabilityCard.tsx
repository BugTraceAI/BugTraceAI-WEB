// version 0.0.44
/* eslint-disable max-lines -- Vulnerability card component (254 lines).
 * Rich vulnerability display with metadata, payloads, and remediation details.
 * Includes expandable sections for PoC, SQLMap commands, XSS payloads, and remediation.
 * Presentation-heavy component with multiple conditional sections - splitting would fragment card structure.
 */
import React, { useState } from 'react';
import { Vulnerability, XssPayloadResult, SqlmapCommandResult } from '../types.ts';
import { Severity } from '../types.ts';
import { SEVERITY_STYLES } from '../constants.ts';
import { generateXssPayload, generateSqlmapCommand } from '../services/Service.ts';
import { useApiOptions } from '../hooks/useApiOptions.ts';
import { Spinner } from './Spinner.tsx';
import { CommandLineIcon, FireIcon, BeakerIcon, ChevronDownIcon, ChevronUpIcon, ChatIcon, KeyIcon } from './Icons.tsx';
import { XssPayloadTester } from './XssPayloadTester.tsx';
import { MarkdownRenderer } from './MarkdownRenderer.tsx';

interface VulnerabilityCardProps {
  vulnerability: Vulnerability;
  analyzedTarget: string;
  onSendToPayloadForge?: (payload: string) => void;
  onSendToJwtAnalyzer?: (token: string) => void;
  onShowExploitAssistant?: () => void;
  onShowSqlExploitAssistant?: () => void;
  onAnalyzeWithAgent?: () => void;
  onShowApiKeyWarning?: () => void; // Added for completeness, though actions here have checks
}

export const VulnerabilityCard: React.FC<VulnerabilityCardProps> = ({ vulnerability, analyzedTarget, onSendToPayloadForge, onSendToJwtAnalyzer, onShowExploitAssistant, onShowSqlExploitAssistant, onAnalyzeWithAgent, onShowApiKeyWarning }) => {
  const severityStyle = SEVERITY_STYLES[vulnerability.severity] || SEVERITY_STYLES[Severity.UNKNOWN];
  const { apiOptions, isApiKeySet } = useApiOptions();

  const [isGenerating, setIsGenerating] = useState<string | null>(null); // 'xss', 'sql'
  const [generatedXssResult, setGeneratedXssResult] = useState<XssPayloadResult | null>(null);
  const [generatedSqlCommand, setGeneratedSqlCommand] = useState<SqlmapCommandResult | null>(null);
  const [generationError, setGenerationError] = useState<string | null>(null);
  const [isRecommendationOpen, setIsRecommendationOpen] = useState(false);

  // FIX: Ensure vulnerableCode is always a string to prevent runtime errors.
  const vulnerableCode = typeof vulnerability.vulnerableCode === 'string' ? vulnerability.vulnerableCode : '';

  const handleGeneratePayload = async () => {
    if (!isApiKeySet && onShowApiKeyWarning) {
      onShowApiKeyWarning();
      return;
    }
    setGenerationError(null);
    setIsGenerating('xss');
    setGeneratedXssResult(null);
    setGeneratedSqlCommand(null);

    try {
      const response = await fetch('/payloads/xsspayloads.txt');
      if (!response.ok) {
        console.warn('Could not load xsspayloads.txt, proceeding with standard generation.');
      }
      const text = response.ok ? await response.text() : '';
      const allPayloads = text.split('\n').filter(p => p.trim() !== '' && !p.startsWith('#'));

      const sampleSize = 50;
      const sampledPayloads = allPayloads.length > sampleSize
        ? allPayloads.sort(() => 0.5 - Math.random()).slice(0, sampleSize)
        : allPayloads;

      const result = await generateXssPayload(vulnerability, apiOptions!, sampledPayloads);
      setGeneratedXssResult(result);
    } catch (e: any) {
      setGenerationError(e.message || "An unknown error occurred during payload generation.");
    } finally {
      setIsGenerating(null);
    }
  };

  const handleGenerateSqlCommand = async () => {
    if (!isApiKeySet && onShowApiKeyWarning) {
      onShowApiKeyWarning();
      return;
    }
    setGenerationError(null);
    setIsGenerating('sql');
    setGeneratedXssResult(null);
    setGeneratedSqlCommand(null);

    try {
      const result = await generateSqlmapCommand(vulnerability, analyzedTarget, apiOptions!);
      setGeneratedSqlCommand(result);
    } catch (e: any) {
      setGenerationError(e.message || "An unknown error occurred during command generation.");
    } finally {
      setIsGenerating(null);
    }
  };

  const handleCopyCommand = () => {
    if (generatedSqlCommand?.command) {
      navigator.clipboard.writeText(generatedSqlCommand.command);
    }
  };

  const vulnName = (vulnerability.vulnerability || '').toLowerCase();
  const isXss = vulnName.includes('xss') || vulnName.includes('cross-site scripting');
  const isSqli = vulnName.includes('sql');
  const isJwt = vulnName.includes('jwt') || (vulnerableCode && vulnerableCode.startsWith('ey'));

  const forgeableKeywords = [
    'xss',
    'cross-site scripting',
    'command injection',
    'template injection',
    'ssti',
    'lfi',
    'path traversal',
    'file inclusion',
  ];
  const isForgeable = forgeableKeywords.some(keyword => vulnName.includes(keyword));

  return (
    <div className={`bg-purple-medium/50 backdrop-blur-sm border ${severityStyle.border} rounded-xl overflow-hidden shadow-xl ${severityStyle.shadow} animate-fade-in hover:shadow-2xl transition-all duration-300`}>
      <header className={`p-5 flex justify-between items-start gap-4 ${severityStyle.headerBg} border-b ${severityStyle.border}`}>
        <div className="flex-grow">
          <h4 className={`text-xl font-bold tracking-tight ${severityStyle.text}`}>{vulnerability.vulnerability || 'Unnamed Finding'}</h4>
          <p className={`text-[11px] font-bold uppercase tracking-widest ${severityStyle.text} opacity-60 mt-1`}>Target: {analyzedTarget}</p>
        </div>
        <div className={`flex-shrink-0 px-4 py-1.5 text-[10px] font-black uppercase tracking-tighter rounded-lg border-2 ${severityStyle.border} ${severityStyle.text} bg-black/40 shadow-inner`}>
          {vulnerability.severity}
        </div>
      </header>

      <div className="p-4 space-y-4">
        <div>
          <h5 className="font-semibold text-white mb-1">Description</h5>
          <div><MarkdownRenderer content={vulnerability.description} /></div>
        </div>

        <div>
          <h5 className="font-semibold text-white mb-1">Impact</h5>
          <p className="text-sm text-purple-gray">{vulnerability.impact}</p>
        </div>

        {vulnerableCode && (
          <div className="group relative">
            <h5 className="label-mini mb-2 ml-1">Payload / Vulnerable Pattern</h5>
            <div className="relative">
              <pre className="w-full bg-ui-input-bg/40 border border-ui-border rounded-2xl p-4 text-ui-text-main text-xs overflow-x-auto backdrop-blur-md shadow-inner"><code>{vulnerableCode}</code></pre>
              <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onClick={() => navigator.clipboard.writeText(vulnerableCode)} className="p-1.5 rounded-lg bg-ui-bg/80 hover:bg-ui-accent hover:text-white transition-all text-ui-text-dim">
                  <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                </button>
              </div>
            </div>
          </div>
        )}

        <div>
          <button
            onClick={() => setIsRecommendationOpen(!isRecommendationOpen)}
            className="w-full flex justify-between items-center text-left font-semibold text-white py-2"
          >
            Recommendation
            {isRecommendationOpen ? <ChevronUpIcon className="h-5 w-5" /> : <ChevronDownIcon className="h-5 w-5" />}
          </button>
          {isRecommendationOpen && (
            <div className="text-sm text-purple-gray border-t border-0 pt-2">
              <MarkdownRenderer content={vulnerability.recommendation} />
            </div>
          )}
        </div>

        {(generatedXssResult || generatedSqlCommand || generationError) && (
          <div className="border-t border-0 pt-4">
            {generationError && <div className="p-2 mb-2 text-xs bg-red-900/50 border border-red-700 text-red-200 rounded-lg font-mono">{generationError}</div>}
            {generatedXssResult && (
              <div className="space-y-4">
                <h6 className="font-semibold text-coral-hover">{generatedXssResult.explanation}</h6>
                {generatedXssResult.payloads.map((p, i) => (
                  <div key={i} className="pl-4 border-l-2 border-coral/30">
                    <p className="font-bold text-sm text-white">{p.description}</p>
                    <p className="text-xs text-muted mb-1">{p.mechanism}</p>
                    {vulnerability.injectionPoint && analyzedTarget.startsWith('http') ? (
                      <XssPayloadTester
                        payload={p.payload}
                        analyzedTarget={analyzedTarget}
                        injectionPoint={vulnerability.injectionPoint}
                        onSendToPayloadForge={onSendToPayloadForge}
                      />
                    ) : (
                      <div className="space-y-2">
                        <pre className="w-full bg-black/30 border border-purple-800/50 rounded-lg p-3 text-purple-200 text-sm overflow-x-auto">
                          <code>{p.payload}</code>
                        </pre>
                        <div className="flex items-start flex-wrap gap-2">
                          {onSendToPayloadForge && (
                            <button
                              onClick={() => onSendToPayloadForge(p.payload)}
                              className="btn-mini btn-mini-primary !py-2 px-5 !rounded-lg gap-2"
                              title="Send this generated payload to the Payload Forge."
                            >
                              <FireIcon className="h-4 w-4" />
                              SEND TO FORGE
                            </button>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
            {generatedSqlCommand && (
              <div className="space-y-2">
                <h6 className="font-semibold text-coral-hover">Generated SQLMap Command</h6>
                <p className="text-sm text-purple-gray">{generatedSqlCommand.explanation}</p>
                <div className="relative group">
                  <pre className="w-full bg-black/30 border border-purple-800/50 rounded-xl p-3 text-purple-200 text-sm overflow-x-auto">
                    <code>{generatedSqlCommand.command}</code>
                  </pre>
                  <button onClick={handleCopyCommand} className="absolute top-2 right-2 p-1.5 rounded-lg bg-purple-900/50 hover:bg-purple-900/80 text-purple-200 opacity-0 group-hover:opacity-100 transition-opacity">Copy</button>
                </div>
              </div>
            )}
          </div>
        )}
      </div>

      <footer className="p-4 bg-dashboard-bg/50 border-t border-ui-border flex flex-wrap items-center gap-3">
        {isXss && onShowExploitAssistant && (
          <button onClick={onShowExploitAssistant} className="btn-mini btn-mini-secondary !border-blue-500/30 !bg-blue-500/5 hover:!bg-blue-500/10 px-4 !rounded-xl">
            <BeakerIcon className="h-4 w-4 mr-2" /> Exploit Path
          </button>
        )}
        {isSqli && onShowSqlExploitAssistant && vulnerability.injectionPoint && (
          <button onClick={onShowSqlExploitAssistant} className="btn-mini btn-mini-secondary !border-blue-500/30 !bg-blue-500/5 hover:!bg-blue-500/10 px-4 !rounded-xl">
            <BeakerIcon className="h-4 w-4 mr-2" /> Exploit Path
          </button>
        )}
        {isXss && (
          <button onClick={handleGeneratePayload} disabled={isGenerating === 'xss'} className="btn-mini btn-mini-primary !bg-ui-accent/80 hover:!bg-ui-accent px-4 !rounded-xl">
            {isGenerating === 'xss' ? <Spinner /> : <FireIcon className="h-4 w-4 mr-2" />} XSS Payloads
          </button>
        )}
        {onSendToPayloadForge && vulnerableCode && isForgeable && (
          <button onClick={() => onSendToPayloadForge(vulnerableCode)} className="btn-mini btn-mini-primary !bg-orange-600/80 hover:!bg-orange-600 px-4 !rounded-xl" title="Send patent to Forge">
            <FireIcon className="h-4 w-4 mr-2" /> TO FORGE
          </button>
        )}
        {isSqli && vulnerability.injectionPoint && (
          <button onClick={handleGenerateSqlCommand} disabled={isGenerating === 'sql'} className="btn-mini btn-mini-primary !bg-pink-600/80 hover:!bg-pink-600 px-4 !rounded-xl">
            {isGenerating === 'sql' ? <Spinner /> : <CommandLineIcon className="h-4 w-4 mr-2" />} SQLMap Command
          </button>
        )}
        {onAnalyzeWithAgent && (
          <button onClick={onAnalyzeWithAgent} className="btn-mini btn-mini-primary !bg-blue-600/80 hover:!bg-blue-600 px-4 !rounded-xl">
            <ChatIcon className="h-4 w-4 mr-2" /> AGENT AUDIT
          </button>
        )}
        {isJwt && onSendToJwtAnalyzer && (
          <button onClick={() => onSendToJwtAnalyzer(vulnerableCode)} className="btn-mini btn-mini-primary !bg-yellow-600/80 hover:!bg-yellow-600 px-4 !rounded-xl">
            <KeyIcon className="h-4 w-4 mr-2" /> JWT ANALYZER
          </button>
        )}
      </footer>
    </div>
  );
}